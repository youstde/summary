
## Promise ä¸å¾®ä»»åŠ¡
[åŸæ–‡é“¾æ¥ğŸ”—](https://zhuanlan.zhihu.com/p/449183802)

è¿™æ˜¯ä¸€ä¸ªå…³äºPromise å¾®ä»»åŠ¡çš„é¢˜ç›®ï¼ŒçŒœçŒœä»¥ä¸‹ä»£ç è¾“å‡ºæ˜¯ä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆï¼Ÿ
```js
let p1 = Promise.resolve()
  .then(function f1(v) { console.log(1) })
  .then(function f2(v) { console.log(2) })
  .then(function f3(v) { console.log(3) })
 
p1.then(function f4(v) { console.log(4) })
p1.then(function f5(v) { console.log(5) })

let p2 = Promise.resolve()
  .then(function f11(v) { console.log(11) })
  .then(function f22(v) { console.log(22) })
  .then(function f33(v) { console.log(33) })
 
p2.then(function f44(v) { console.log(44) })
p2.then(function f55(v) { console.log(55) })
```

---
- æœ‰çš„å°ä¼™ä¼´ä¼šè®¤ä¸ºè¾“å‡ºçš„ç»“æœæ˜¯ 1, 2, 3, 4, 5, 11, 22, 33, 44, 55ã€‚å…¶ç†è®ºä¾æ®æ˜¯â€œPromiseçš„thenå±äºå¾®ä»»åŠ¡ï¼Œä»£ç åœ¨æ‰§è¡Œçš„æ—¶å€™ï¼Œé‡åˆ°.then(fn)ï¼Œ ä¼šæŠŠfnåŠ å…¥åˆ°å¾®ä»»åŠ¡é˜Ÿåˆ—â€ï¼Œæ‰€ä»¥è¿™äº›thené‡Œçš„å›è°ƒå‡½æ•°è¢«ä¾æ¬¡åŠ å…¥å¾®ä»»åŠ¡é˜Ÿåˆ—ï¼Œåˆ°æ‰§è¡Œé˜Ÿåˆ—ä»»åŠ¡æ—¶å°±ä¼šä¾æ¬¡è¾“å‡ºã€‚

- æœ‰çš„å°ä¼™ä¼´ä¼šè®¤ä¸ºè¾“å‡ºçš„ç»“æœæ˜¯ 1ã€11ã€2ã€22ã€3ã€33ã€4ã€44ã€5ã€55ã€‚ç†ç”±æ˜¯â€œPromiseçš„thenå±äºå¾®ä»»åŠ¡ï¼Œä½†åªæœ‰å½“å‰ä¸€ä¸ªPromiseå¯¹è±¡çš„resolveï¼Œæ‰ä¼šè§¦å‘è®©å…¶åçš„.then(fn)ä¸­çš„fnåŠ å…¥å¾®ä»»åŠ¡é˜Ÿåˆ—â€ã€‚æ‰€ä»¥ä¸€å¼€å§‹å¾®ä»»åŠ¡é˜Ÿåˆ—æ˜¯[f1, f11]ï¼Œ æ‰§è¡Œf1æ—¶(returnçš„æ˜¯undefinedï¼Œ)å¯¼è‡´å½“å‰promiseå¯¹è±¡resovle(undefined)ï¼Œä»è€ŒæŠŠf2åŠ å¾®ä»»åŠ¡é˜Ÿåˆ—[f11, f2]ï¼Œf11æ‰§è¡Œæ—¶åŒæ ·æŠŠf22åŠ ä»»åŠ¡é˜Ÿåˆ—[f2, f22]ï¼Œä¸€æ¬¡è½®æµæ‰§è¡Œã€‚

ä¸¤ç§è¯´æ³•éƒ½æ²¡é—®é¢˜ï¼Œé—®é¢˜åœ¨äºä¸å¤Ÿä¸¥è°¨ï¼Œä¸èƒ½æè¿°å½“å‰è¿™ä¸ªä¾‹å­ï¼Œå¯¼è‡´å¾—å‡ºé”™è¯¯çš„æ¨æ–­ç»“æœã€‚æ›´ä¸¥è°¨çš„è¯´æ³•æ˜¯ï¼š

**å¯¹äºä¸€å¤„äºpendingçŠ¶æ€çš„Promiseå¯¹è±¡pï¼Œå†…éƒ¨çŠ¶æ€çš„resolveï¼Œä¼šè®©p.then(fn)ä¸­çš„fnåŠ å…¥å¾®ä»»åŠ¡é˜Ÿåˆ—**

```js
//code 1
let p = new Promise(function f1(resolve) {
  setTimeout(function f2(){ 
    resolve(2) 
    console.log(1)
  }, 1000)
})
p.then(function f3(v) { console.log(v) })
```

åœ¨ä¸Šä¾‹ä¸­ï¼Œf1æ˜¯åŒæ­¥æ‰§è¡Œçš„ä»£ç ï¼Œåœ¨æ‰§è¡Œæ—¶åˆ›å»ºä¸€ä¸ªå®šæ—¶å™¨ï¼ˆf2ä¼šåŠ å…¥å®é˜Ÿåˆ—ï¼‰ï¼Œä¹‹åæ‰§è¡Œ p.thenï¼Œæ­¤æ—¶ f3å¹¶æ²¡æœ‰ç«‹å³åŠ å…¥å¾®ä»»åŠ¡é˜Ÿåˆ—ã€‚ 1ç§’å f2æ‰§è¡Œæ—¶ï¼Œè¿è¡Œ resolve(1)ï¼Œæ­¤æ—¶æ‰è§¦å‘f3åŠ å¾®ä»»åŠ¡é˜Ÿåˆ—ã€‚ è¯¦ç»†çš„æµç¨‹æ˜¯

- è¿è¡ŒåŒæ­¥ä»£ç f1ï¼Œåˆ›å»ºå®šæ—¶å™¨ï¼Œåˆå§‹åŒ–p.then

- 1ç§’ä¹‹åï¼Œf2åŠ å…¥å®é˜Ÿåˆ—ã€‚æ­¤æ—¶å®é˜Ÿåˆ—ï¼š[f2]ï¼Œ å¾®é˜Ÿåˆ—: []ã€‚

- å…ˆæ‰«æå¾®é˜Ÿåˆ—ï¼ˆä¸ºç©ºï¼‰ï¼Œå†æ‰«æå®é˜Ÿåˆ—ï¼ˆæ‹¿å‡ºä¸€ä¸ªä»»åŠ¡f2ï¼‰ï¼Œè¿è¡Œf2ã€‚é‡åˆ°resolveï¼Œè§¦å‘æŠŠä¹‹å‰p.then(f3)çš„f3ç§»å…¥å¾®ä»»åŠ¡é˜Ÿåˆ—ï¼Œä¹‹åè¾“å‡º1ã€‚æ­¤æ—¶å®é˜Ÿåˆ—ï¼š[]ï¼Œ å¾®é˜Ÿåˆ—: [f3]ã€‚

- æ‰«ç å¾®é˜Ÿåˆ—ï¼Œä¾æ¬¡æ‹¿å‡ºå¹¶è¿è¡Œå…¨éƒ¨ä»»åŠ¡ï¼Œæ‰§è¡Œf3è¾“å‡º2ã€‚

- æ‰€ä»¥æœ€è¾“å‡ºç»“æœæ˜¯1ç§’ä¹‹åç«‹å³ä¾æ¬¡å‡ºç° 1ã€2

```js
//code 2
let p1 = new Promise(function f1(resolve1) {
  setTimeout(resolve1)
})
let p2 = p1.then(function f2(v) { console.log(2) })
let p3 = p2.then(function f3(v) { console.log(3) })

let p11 = new Promise(function f11(resolve2) {
  setTimeout(resolve2)
})
let p22 = p11.then(function f22(v) { console.log(22) })
let p33 = p22.then(function f33(v) { console.log(33) })
```
å¯¹äºPromiseæˆ‘ä»¬éœ€è¦çŸ¥é“ï¼Œé“¾å¼è°ƒç”¨.thenä¹‹åä¼šè¿”å›ä¸€ä¸ªæ–°çš„Promiseå¯¹è±¡ã€‚ä»¥ä¸Šä»£ç çš„æ‰§è¡Œæµç¨‹æ˜¯

- å…ˆæ‰§è¡ŒåŒæ­¥çš„ä»£ç ã€‚è¿è¡Œf1ï¼Œç«‹å³å¾—åˆ°ä¸€ä¸ªpendingçŠ¶æ€çš„Promiseå¯¹è±¡p1ï¼ˆf1é‡Œé¢çš„resolve1å‡½æ•°è¢«åŠ å…¥å®ä»»åŠ¡ï¼Œè¿˜æ²¡å¼€å§‹æ‰§è¡Œï¼‰ã€‚è¿è¡Œp1.thenå¾—åˆ°ä¸€ä¸ªpendingçŠ¶æ€çš„Promiseå¯¹è±¡p2ã€‚... ï¼ŒåŒç†å¾—åˆ°ä¸€ä¸ªpendingçŠ¶æ€çš„Promiseå¯¹è±¡p33ã€‚æ­¤æ—¶å®é˜Ÿåˆ—é‡Œæœ‰[resolve1, resolve2]ã€‚

- å› å¾®é˜Ÿåˆ—ç›®å‰ä¸ºç©ºï¼Œæ‰€ä»¥æ‰«æå®é˜Ÿåˆ—ï¼Œæ‹¿å‡ºresolve1è¿è¡Œï¼Œå¯¼è‡´p1è¢«resolveï¼ˆä»pendingå˜æˆfulfilledï¼‰ï¼Œä»è€Œå¯¼è‡´p1.then(f2)ä¸­çš„f2è¢«åŠ å…¥å¾®é˜Ÿåˆ—ã€‚æ­¤æ—¶å®é˜Ÿåˆ—[resolve2]ï¼Œå¾®é˜Ÿåˆ—[f2]ã€‚
æ‰«æå…¨éƒ¨å¾®ä»»åŠ¡ï¼Œæ‹¿å‡ºf2è¿è¡Œï¼Œè¾“å‡º2ã€‚f2è¿è¡Œç»“æŸï¼ˆå‡½æ•°ç»“æŸæˆ–è€…é‡åˆ°returnï¼‰æ—¶ï¼Œè§¦å‘p2å†…éƒ¨çŠ¶æ€çš„å˜åŒ–ï¼ˆp2ä»pendingå˜æˆfulfilledï¼‰ï¼Œå¯¼è‡´p2.then(f3)ä¸­çš„f3åŠ å…¥å¾®ä»»åŠ¡é˜Ÿåˆ—ã€‚æ­¤æ—¶å®é˜Ÿåˆ—[resolve2]ï¼Œå¾®é˜Ÿåˆ—[f3]ã€‚å¾®ä»»åŠ¡é˜Ÿåˆ—ä¸ä¸ºç©ºï¼Œæ‹¿å‡ºf3ï¼Œè¿è¡Œè¾“å‡º3ï¼Œæ­¤æ—¶p3å˜æˆfulfilledçŠ¶æ€ã€‚å¾®é˜Ÿåˆ—ä¸º[]ã€‚

- æ‰«æä¸‹ä¸€ä¸ªå®ä»»åŠ¡ï¼Œæ‹¿å‡ºresolve2ï¼Œè¿è¡Œï¼Œå¯¼è‡´p11è¢«resolveï¼Œä»è€Œå¯¼è‡´p11.then(f22)ä¸­çš„f22è¢«åŠ å…¥å¾®é˜Ÿåˆ—ã€‚æ­¤æ—¶å®é˜Ÿåˆ—[]ï¼Œå¾®é˜Ÿåˆ—[f22]ã€‚

- æ‰«æå…¨éƒ¨å¾®ä»»åŠ¡ï¼Œæ‹¿å‡ºf22è¿è¡Œï¼Œè¾“å‡º22ã€‚f22è¿è¡Œç»“æŸæ—¶ï¼Œè§¦å‘p22ä»pendingå˜æˆfulfilledï¼Œå¯¼è‡´p22.then(f33)ä¸­çš„f33åŠ å…¥å¾®ä»»åŠ¡é˜Ÿåˆ—ã€‚æ­¤æ—¶å®é˜Ÿåˆ—[]ï¼Œå¾®é˜Ÿåˆ—[f33]ã€‚å¾®ä»»åŠ¡é˜Ÿåˆ—è¿˜æœªæ‰«æå®Œï¼Œæ‹¿å‡ºf33ï¼Œè¿è¡Œè¾“å‡º33ï¼Œæ­¤æ—¶p33å˜æˆfulfilledçŠ¶æ€ã€‚å¾®é˜Ÿåˆ—ä¸º[]ã€‚

æœ€ç»ˆè¾“å‡ºé¡ºåºä¸º 2ã€3ã€22ã€33ã€‚ä»¥ä¸Šä»£ç ç­‰ä»·äºå¸¸è§é“¾å¼å†™æ³•
```js
new Promise( resolve => setTimeout(resolve) )
  .then( v => console.log(2) )
  .then( v => console.log(3) )

new Promise( resolve => setTimeout(resolve) )
  .then( v => console.log(22) )
  .then( v => console.log(33) )
```

æ­¤æ—¶ä¸€åˆ‡è¿˜ç¬¦åˆæˆ‘ä»¬çš„é¢„æœŸã€‚å†çœ‹ä¸‹ä¸€æ¡è§„åˆ™ï¼š
**å¯¹äºä¸€å¤„äºfulfilledçŠ¶æ€çš„Promiseå¯¹è±¡pï¼Œp.then(fn)ä¼šç«‹å³è®©fnåŠ å…¥å¾®ä»»åŠ¡é˜Ÿåˆ—**

```js
// code 3
let p1 = Promise.resolve(1)
let p2 = p1.then(function f2() {
  console.log(2)
})
let p3 = p2.then(function f3() {
  console.log(3)
})

let p11 = new Promise(function f11(resolve) {
  resolve(11)
})
let p22 = p11.then(function f22() {
  console.log(22)
})
let p33 = p22.then(function f33() {
  console.log(33)
})
```

çœ‹èµ·æ¥å’Œ code 2 ä»£ç ç±»ä¼¼ï¼Œåœ¨å®é™…æ‰§è¡Œçš„æ—¶å€™ä¼šå‘ç°å¾—åˆ°æˆªç„¶ä¸åŒçš„ç»“æœã€‚åˆ†æä¸€ä¸‹å…·ä½“æ‰§è¡Œæµç¨‹ï¼š
- å…ˆæ‰§è¡ŒåŒæ­¥ä»£ç ã€‚
    1. p1 = Promise.resolve()ã€‚åˆ›å»ºä¸€ä¸ªPromiseå¯¹è±¡p1ï¼Œå…¶å†…éƒ¨çŠ¶æ€ä¸º fulfilledã€‚
    2. p2 = p1.then(f2) ã€‚å¯¹äºä¸€å¤„äºfulfilledçŠ¶æ€çš„Promiseå¯¹è±¡p1ï¼Œä¼šç«‹å³è®©f2åŠ å…¥å¾®ä»»åŠ¡é˜Ÿåˆ—ï¼ˆf2å¹¶æœªæ‰§è¡Œï¼‰ï¼Œåˆ›å»ºçš„p2æ˜¯pendingçŠ¶æ€ã€‚æ­¤åˆ»å¾®é˜Ÿåˆ—ä¸º[f2]
    3. p3 = p2.then(f3)ã€‚å¯¹äºä¸€å¤„äºpendingçŠ¶æ€çš„Promiseå¯¹è±¡p2ï¼Œå†…éƒ¨resolveæ‰ä¼šè®©f3åŠ å…¥å¾®é˜Ÿåˆ—ï¼ˆå› ä¸ºp2è¿˜æ²¡resolveï¼Œæ‰€ä»¥f3è¿˜æ²¡åŠ å¾®é˜Ÿåˆ—ï¼‰ã€‚
    4. p11 =new Promise(functionf11(resolve){ resolve(11) })ã€‚ åˆ›å»ºä¸€ä¸ªPromiseå¯¹è±¡p11ï¼Œå†…éƒ¨çŠ¶æ€ä¸ºfulfilled
    5. p22 = p11.then(f22)ã€‚å¯¹äºä¸€å¤„äºfulfilledçŠ¶æ€çš„Promiseå¯¹è±¡p11ï¼Œä¼šç«‹å³è®©f22åŠ å…¥å¾®ä»»åŠ¡é˜Ÿåˆ—ï¼Œåˆ›å»ºçš„p22æ˜¯pendingçŠ¶æ€ã€‚æ­¤åˆ»å¾®é˜Ÿåˆ—æ˜¯[f2, f22]
    6. p33 = p22.then(f33)ã€‚å¯¹äºä¸€å¤„äºpendingçŠ¶æ€çš„Promiseå¯¹è±¡p22ï¼Œå†…éƒ¨resolveæ‰ä¼šè®©f33åŠ å…¥å¾®é˜Ÿåˆ—ï¼ˆå› ä¸ºp22è¿˜æ²¡fulfilledï¼Œæ‰€ä»¥f33è¿˜æ²¡åŠ å¾®é˜Ÿåˆ—ï¼‰ã€‚
- æ‰«æå¾®ä»»åŠ¡é˜Ÿåˆ—
    1. æ‹¿å‡ºf2ï¼Œè¿è¡Œè¾“å‡º2ã€‚f2æ‰§è¡Œå®Œæ—¶ï¼ˆå‡½æ•°ç»“æŸæˆ–è€…é‡åˆ°turnï¼‰ï¼Œp2è¢«resolveï¼ˆå˜æˆfulfilledçŠ¶æ€ï¼‰ï¼Œè§¦å‘f3åŠ å…¥å¾®é˜Ÿåˆ—ã€‚æ­¤åˆ»å¾®é˜Ÿåˆ—ä¸º[f22, f3]
    2. æ‹¿å‡ºf22ï¼Œè¿è¡Œè¾“å‡º22ã€‚f22æ‰§è¡Œå®Œæ—¶ï¼Œp22è¢«resolveï¼Œè§¦å‘f33åŠ å…¥å¾®é˜Ÿåˆ—ã€‚æ­¤åˆ»å¾®é˜Ÿåˆ—ä¸º[f3, f33]
    3. æ‹¿å‡ºf3ï¼Œè¿è¡Œè¾“å‡º3ã€‚f3æ‰§è¡Œå®Œï¼Œp3å˜æˆfulfilledçŠ¶æ€ã€‚
    4. æ‹¿å‡ºf33ï¼Œè¿è¡Œè¾“å‡º33ã€‚f33æ‰§è¡Œå®Œï¼Œp33å˜æˆfulfilledçŠ¶æ€ã€‚

æœ€ç»ˆè¾“å‡ºç»“æœä¸º 2ã€22ã€3ã€33ã€‚ä»¥ä¸Šä»£ç ç­‰ä»·äºå¸¸è§é“¾å¼å†™æ³•
```js
// code 4
Promise.resolve(1)
  .then(() => console.log(2))
  .then(() => console.log(3))

new Promise(resolve => resolve())
  .then(() => console.log(22))
  .then(() => console.log(33))
```

**æœ€å**

å›åˆ°å¼€å¤´çš„ä¾‹å­
```js
let p1 = Promise.resolve()     //1
  .then(function f1(v) { console.log(1) })  //2
  .then(function f2(v) { console.log(2) })  //3
  .then(function f3(v) { console.log(3) })  //4
  
p1.then(function f4(v) { console.log(4) })   //5
p1.then(function f5(v) { console.log(5) })   //6 

let p2 = Promise.resolve()            //7
  .then(function f11(v) { console.log(11) })  //8
  .then(function f22(v) { console.log(22) })  //9
  .then(function f33(v) { console.log(33) })  //10
 
p2.then(function f44(v) { console.log(44) })  //11
p2.then(function f55(v) { console.log(55) })  //12

```

p1æ˜¯ç¬¬4è¡Œthenå¾—åˆ°çš„Promiseå¯¹è±¡ï¼Œ p2æ˜¯ç¬¬10è¡Œthenå¾—åˆ°çš„å¯¹è±¡ã€‚ä¸€å¼€å§‹ï¼Œä»£ç æŒ‰ç…§code4 çš„é€»è¾‘æ‰§è¡Œã€‚ä¾æ¬¡è¾“å‡º 1ã€11ã€2ã€22ã€3ï¼ˆè¿è¡Œf3ï¼‰ã€33ï¼ˆè¿è¡Œf33ï¼‰ã€‚å½“è¿è¡Œåˆ°f3åï¼Œp1 è¢«resolveï¼Œå¯¼è‡´f4ã€f5è¢«åŒæ—¶åŠ å…¥å¾®é˜Ÿåˆ—ã€‚å½“è¿è¡Œåˆ°f33æ—¶ï¼Œp2è¢«resolveï¼Œå¯¼è‡´f44ã€f55è¢«åŒæ—¶åŠ å…¥å¾®é˜Ÿåˆ—ã€‚æœ€åå¾®é˜Ÿåˆ—é‡Œä¸º[f4, f5, f44, f55]ï¼Œæ‰€ä»¥æœ€åä¾æ¬¡è¾“å‡º4ã€5ã€44ã€55

åˆ°ç›®å‰ä¸ºæ­¢ï¼Œä½ åº”è¯¥çœŸæ­£ç†è§£äº†å®ä»»åŠ¡ã€å¾®ä»»åŠ¡ã€ä»¥åŠPromiseã€‚
